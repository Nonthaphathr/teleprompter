<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Teleprompter</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Sarabun', sans-serif; overflow: hidden; }

        /* --- 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Editor Screen) --- */
        #editor-screen {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f4f4f9;
            padding: 20px;
            box-sizing: border-box;
        }
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            align-items: center;
        }
        textarea {
            flex-grow: 1;
            width: 100%;
            padding: 20px;
            font-size: 18px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
        }
        button.start-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button.start-btn:hover { background-color: #218838; }

        /* --- 2. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Prompter Screen) --- */
        #prompter-screen {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            color: #fff;
            flex-direction: column;
        }
        #qr-overlay {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #qr-overlay button {
            margin-top: 10px;
            cursor: pointer;
            padding: 5px 10px;
        }
        #prompter-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            font-size: 60px; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            line-height: 1.6;
            padding: 0 100px; /* ‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
        }
        #scrolling-text {
            position: absolute;
            top: 100%;
            left: 50px; right: 50px;
            text-align: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        }
        .guide-line {
            position: absolute;
            top: 40%; left: 0; width: 100%; height: 2px;
            background: red; opacity: 0.3; z-index: 10; pointer-events: none;
        }
        .mirror { transform: scaleX(-1); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="editor-screen">
        <div class="toolbar">
            <h2>üìù ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏ó‡∏û‡∏π‡∏î</h2>
            <div style="flex-grow: 1;"></div> <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: <input type="number" id="input-font-size" value="60" style="width: 50px;"> px</label>
            <button class="start-btn" onclick="startPrompter()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô & ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
        </div>
        <textarea id="script-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
    </div>

    <div id="prompter-screen">
        <div id="qr-overlay">
            <canvas id="qr-code"></canvas>
            <div id="room-info" style="color:black; margin-top:5px; font-weight:bold;"></div>
            <button onclick="document.getElementById('qr-overlay').classList.add('hidden')">‚ùå ‡∏ã‡πà‡∏≠‡∏ô QR</button>
        </div>

        <div class="guide-line"></div>
        
        <div id="prompter-container">
            <div id="scrolling-text"></div>
        </div>
    </div>

    <script>
        // --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ---
        const BACKEND_URL = "https://teleprompter-09ku.onrender.com"; // URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const socket = io(BACKEND_URL);

        let sessionId = Math.random().toString(36).substring(2, 6).toUpperCase();
        let isScrolling = false;
        let scrollSpeed = 2;
        let currentPosition = 0;
        let animationFrameId;

        // Elements
        const editorScreen = document.getElementById('editor-screen');
        const prompterScreen = document.getElementById('prompter-screen');
        const scriptInput = document.getElementById('script-input');
        const scrollingText = document.getElementById('scrolling-text');
        const prompterContainer = document.getElementById('prompter-container');

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
        function startPrompter() {
            const text = scriptInput.value;
            if (!text.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô \n ‡πÄ‡∏õ‡πá‡∏ô <br>)
            scrollingText.innerHTML = text.replace(/\n/g, "<br>");
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
            const fontSize = document.getElementById('input-font-size').value;
            prompterContainer.style.fontSize = fontSize + "px";

            // ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            editorScreen.style.display = "none";
            prompterScreen.style.display = "flex";

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
            generateQRCode();
        }

        function generateQRCode() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Link ‡πÑ‡∏õ‡∏¢‡∏±‡∏á remote.html
            const currentPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            const remoteUrl = `${currentPath}/remote.html?session=${sessionId}`;
            
            document.getElementById('room-info').innerText = "Room: " + sessionId;

            new QRious({
                element: document.getElementById('qr-code'),
                value: remoteUrl,
                size: 180
            });
        }

        // 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket
        socket.on('connect', () => {
            console.log("Connected to Server");
            socket.emit('join-session', sessionId);
        });

        // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        function scroll() {
            if (!isScrolling) return;
            currentPosition -= scrollSpeed;
            scrollingText.style.top = currentPosition + 'px';
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (currentPosition < -scrollingText.offsetHeight) {
                isScrolling = false; // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏î
            } else {
                animationFrameId = requestAnimationFrame(scroll);
            }
        }

        // 4. ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏µ‡πÇ‡∏°‡∏ó
        socket.on('receive-command', (data) => {
            console.log("Command:", data);
            
            if (data.command === 'toggle') {
                isScrolling = !isScrolling;
                if (isScrolling) {
                    if (currentPosition === 0) currentPosition = prompterContainer.offsetHeight;
                    scroll();
                } else {
                    cancelAnimationFrame(animationFrameId);
                }
            } 
            else if (data.command === 'speed') {
                scrollSpeed += data.value;
                if (scrollSpeed < 0) scrollSpeed = 0;
            }
            else if (data.command === 'reset') {
                isScrolling = false;
                cancelAnimationFrame(animationFrameId);
                currentPosition = prompterContainer.offsetHeight;
                scrollingText.style.top = '100%';
                // ‡πÇ‡∏ä‡∏ß‡πå QR Code ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Reset ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
                document.getElementById('qr-overlay').classList.remove('hidden');
            }
            else if (data.command === 'mirror') {
                prompterContainer.classList.toggle('mirror');
            }
            else if (data.command === 'font-size') {
                let currentSize = parseInt(window.getComputedStyle(prompterContainer).fontSize);
                prompterContainer.style.fontSize = (currentSize + (data.value * 5)) + 'px';
            }
        });
    </script>
</body>
</html>
